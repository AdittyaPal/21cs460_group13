<!DOCTYPE html>
<html lang="en">
<head>
<meta charSet="utf-8"/>
	<meta http-equiv="x-ua-compatible" content="ie=edge"/>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
	<style data-href="/styles.42c96ef73847dad18e99.css">
	format("truetype");font-weight:400;font-style:normal}
	.cancel-pad{padding:0 .2em}
	@media screen and (min-width:900px){.ad-banner{display:block!important}}
	.icon-module--root--aZeph{display:inline-flex;align-items:center;justify-content:center}
	.icon-module--icon--1ihz7{fill:currentColor}
	.icon-module--label--fHC-f{position:relative;display:inline-block;margin-left:4px;line-height:1}
	.menu-module--mobileMenuContainer--T9wTN{display:none}
	@media (max-width:683px){.menu-module--mobileMenuContainer--T9wTN{display:flex}}
	.menu-module--desktopMenuContainer--3iXKR{display:block}
	@media (max-width:683px){.menu-module--desktopMenuContainer--3iXKR{display:none}}
	.menu-module--menu--dd4-Y{display:flex;flex:0 0 auto;align-items:center;justify-content:flex-start;max-width:100%;padding:0 15px;list-style:none;border-right:1px solid;margin:0 18px 0 auto}
	.menu-module--menu--dd4-Y li{margin:0 12px}
	.menu-module--menuTrigger--32seM{margin-right:10px;padding:0;line-height:0;background:none;color:inherit;border:none;box-shadow:none;outline:none;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer}
	.menu-module--menu--dd4-Y a{display:inline-block;margin-right:15px;text-decoration:none}
	.menu-module--menu--dd4-Y a:last-of-type{margin-right:0}
	.menu-module--mobileMenu--2VGmR{position:absolute;top:0;right:0;flex-direction:column;align-items:flex-start;background:#fafafa;margin:0;padding:0;text-align:left;list-style:none;border-radius:5px;overflow:hidden;z-index:99}
	.dark-theme .menu-module--mobileMenu--2VGmR{background:#252627}
	.menu-module--mobileMenu--2VGmR li{margin:0;white-space:nowrap}
	.menu-module--mobileMenu--2VGmR li a{display:block;padding:10px 15px}
	.menu-module--mobileMenuOverlay--2RcSs{position:fixed;top:0;bottom:0;left:0;right:0;background:rgba(0,0,0,.2);z-index:10}
	.menu-module--themeToggle--2E8ye{line-height:0;padding:0 5px}
	.menu-module--subMenuTrigger--1crdm,.menu-module--themeToggle--2E8ye{background:none;color:inherit;border:none;box-shadow:none;-webkit-appearance:none;-moz-appearance:none;appearance:none;outline:none}
	.menu-module--subMenuTrigger--1crdm{font-size:inherit;font-weight:inherit;margin:0 12px;padding:0;cursor:pointer}
	.menu-module--subMenu--3Rgj_{position:absolute;max-width:300px;background:#fafafa;box-shadow:0 8px 20px rgba(0,0,0,.12);margin:0;padding:5px;list-style:none;border-radius:5px;top:35px;right:70px;overflow:hidden;z-index:99}
	.dark-theme .menu-module--subMenu--3Rgj_{background:#3b3d42}
	.menu-module--subMenu--3Rgj_ li{text-align:left;margin:0;white-space:nowrap}
	.menu-module--subMenu--3Rgj_ li a{padding:10px}
	.menu-module--subMenu--3Rgj_ li:hover{background:rgba(0,0,0,.05);border-radius:3px;cursor:pointer}
	.dark-theme .menu-module--subMenu--3Rgj_ li:hover{background:rgba(0,0,0,.15)}
	.menu-module--subMenuOverlay--3TQRy{position:fixed;top:0;bottom:0;left:0;right:0;z-index:-1}
	.menu-module--menuArrow--1COMf{display:inline-block;font-family:Inter UI;margin-left:5px;transform:rotate(90deg)}
	.header-module--header--tFeG9{background:#fafafa;display:flex;align-items:center;justify-content:space-between;position:relative;padding:20px}
	.dark-theme .header-module--header--tFeG9{background:#252627}.header-module--header--tFeG9 a{text-decoration:none}
	.header-module--inner--7ao1M{justify-content:space-between;margin:0 auto;width:760px;max-width:100%}
	.header-module--inner--7ao1M,.header-module--logo--2kX-3{display:flex;align-items:center}
	.header-module--text--3UAQj{font-size:18px}
	.header-module--right--1Zeb6{display:flex;position:relative}
	@-webkit-keyframes header-module--cursor--33Aoa{0%{opacity:0}50%{opacity:1}to{opacity:0}}
	@font-face{font-family:Inter UI;font-style:normal;font-weight:400;src:url(/static/Inter-UI-Regular-ecf7c639683dfcb4868861e0c613c455.woff) format("woff")}
	@font-face{font-family:Inter UI;font-style:italic;font-weight:400;src:url(/static/Inter-UI-Italic-bcf654c7bea165e9dae257206c5521ad.woff) format("woff")}
	@font-face{font-family:Inter UI;font-style:normal;font-weight:600;src:url(/static/Inter-UI-Medium-48dfecfe37de0ef8f0e2c2d2e6992e9c.woff) format("woff")}
	@font-face{font-family:Inter UI;font-style:italic;font-weight:600;src:url(/static/Inter-UI-MediumItalic-a9eddc92c84c5f78fba1cb7d7833d31c.woff) format("woff")}
	@font-face{font-family:Inter UI;font-style:normal;font-weight:800;src:url(/static/Inter-UI-Bold-e2158f600a4b0175b73dfefb0d2fe8f8.woff) format("woff")}
	@font-face{font-family:Inter UI;font-style:italic;font-weight:800;src:url(/static/Inter-UI-BoldItalic-dbe4ec1d26d41331c91550939a7fd27f.woff) format("woff")}pre[class*=language-],pre[class*=language-]>code{color:#a9a9b3;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;background:#1a1a1d!important;border-radius:8px}
	.command-line-prompt>span[data-user=root]:before{content:"[" attr(data-user) "@" attr(data-host) "] #"}.command-line-prompt>span[data-prompt]:before{content:attr(data-prompt)}html{box-sizing:border-box}*,:after,:before{box-sizing:inherit}body{margin:0;padding:0;font-family:Inter UI,-apple-system,BlinkMacSystemFont,Roboto,Segoe UI,Helvetica,Arial,sans-serif;font-size:1rem;font-weight:600;line-height:1.54;background-color:#fff;color:#222;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;font-feature-settings:"liga","tnum","case","calt","zero","ss01","locl";-webkit-overflow-scrolling:touch;-webkit-text-size-adjust:100%}@media (max-width:683px){body{font-size:1rem}}
	body.dark-theme{background-color:#292a2d;color:#a9a9b3}h1,h2,h3,h4,h5,h6{display:flex;align-items:center;line-height:1.3}
	h1{font-size:2.625rem}
	h2{font-size:1.625rem}
	h3{font-size:1.375rem}
	h4{font-size:1.125rem}
	@media (max-width:683px){h1{font-size:2rem}h2{font-size:1.4rem}h3{font-size:1.15rem}h4{font-size:1.125rem}}
	a{color:inherit}
	img{display:block;max-width:100%}
	img.center,img.left{margin-right:auto}
	img.center,img.right{margin-left:auto}
	figure{display:table;max-width:100%;margin:25px 0}
	figure.center,figure.left{margin-right:auto}
	figure.center,figure.right{margin-left:auto}
	figure figcaption{font-size:14px;margin-top:5px;opacity:.8}
	figure figcaption.left{text-align:left}
	figure figcaption.center{text-align:center}
	figure figcaption.right{text-align:right}
	code{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-feature-settings:normal;font-weight:400;background:#eaeaea;padding:1px 6px;margin:0 2px;border-radius:5px;font-size:.9rem}
	.dark-theme code{background:#3b3d42}
	pre{background:#1a1a1d;padding:20px;border-radius:8px;font-size:.9rem;overflow:auto}
	@media (max-width:683px){pre{white-space:pre-wrap;word-wrap:break-word}}
	pre code{background:none!important;color:#ccc;margin:0;pdiv.code-toolbar:hover>
	body{margin:0;padding:0;font-family:Inter UI,-apple-system,BlinkMacSystemFont,Roboto,Segoe UI,Helvetica,Arial,sans-serif;font-size:1rem;font-weight:600;line-height:1.54;background-color:#fff;color:#222;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;font-feature-settings:"liga","tnum","case","calt","zero","ss01","locl";-webkit-overflow-scrolling:touch;-webkit-text-size-adjust:100%}
	@media (max-width:683px){body{font-size:1rem}}adding:0;font-size:.9rem}blockquote{border-left:2px solid;margin:40px;padding:10px 20px}
	@media (max-width:683px){blockquote{margin:10px;padding:10px}}blockquote p:first-of-type{margin-top:0}blockquote p:last-of-type{margin-bottom:0}
	table{table-layout:fixed;border-collapse:collapse;width:100%;margin:40px 0;border-radius:5px}
	table,td,th{border:1px solid #222;padding:10px}
	.dark-theme table,.dark-theme td,.dark-theme th{border-color:#a9a9b3}th{background:#eaeaea}
	.dark-theme th{background:#3b3d42}
	ol,ul{margin-left:40px;padding:0}
	@media (max-width:683px){ol,ul{margin-left:20px}}ol ol{list-style-type:lower-alpha}button,input,textarea{font-family:Inter UI,-apple-system,BlinkMacSystemFont,Roboto,Segoe UI,Helvetica,Arial,sans-serif}.container{flex-direction:column;text-align:center}
	.container,.content{display:flex;justify-content:center}
	.content{flex-direction:column;flex:1 0 auto;align-items:center;margin:50px auto;width:100%;max-width:800px}
	@media (max-width:683px){.content{margin-top:0}}
	@media (max-width:899px){.content{max-width:660px}}hr{width:100%;border:none;background:#dcdcdc;height:1px}
	.dark-theme hr{background:#4a4b50}
	.post-module--post--28Mq2{width:100%;max-width:800px;text-align:left;padding:20px;margin:0 auto 20px}
	.post-module--post--28Mq2:not(:last-of-type){border-bottom:1px solid #dcdcdc}.dark-theme .post-module--post--28Mq2:not(:last-of-type){border-color:#4a4b50}@media (max-width:899px){.post-module--post--28Mq2{max-width:660px}}
	.post-module--post--28Mq2 h1{margin:0 0 10px}
	.post-module--post--28Mq2 img{border-radius:8px}.post-module--title--3XBo2 a{text-decoration:none}.post-module--coverImage--1GM7V{border-radius:8px;margin-bottom:40px;box-shadow:0 15px 30px rgba(0,0,0,.1)}
	.post-module--meta--3YtjE{font-size:1rem;margin-bottom:30px}.post-module--tags--3RbqF{margin-top:10px;opacity:.5}.post-module--tag--16U9p{margin-right:10px}.post-module--readMore--3zWML,.post-module--tag--16U9p{display:inline-block}.post-module--readMore--3zWML{text-decoration:none;font-weight:700;margin:20px 0;font-size:1rem}.post-module--postContent--1bfnt{position:relative}
	</style>
	<link rel="stylesheet" href="base.css">
	<meta name="generator" content="Gatsby 2.23.11"/>
	<title data-react-helmet="true">
		CS460: Final Report
	</title>
	<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
	<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-MML-AM_CHTML"></script>
	<meta data-react-helmet="true" name="description" content="Final Report for the Project in requirement of the course CS460"/>
	<meta data-react-helmet="true" name="keywords" content="gatsby, minimal, starter, blog, theme, dark, light, personal site"/>
	<link rel="icon" href="/favicon-32x32.png?v=20d2ef53a71d2dd13985c679b0f8e708"/>
	<meta name="theme-color" content="#292a2d"/>
	<link href="./ProjectProposal/prism.css" rel="stylesheet" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body, html {
  height: 100%;
  margin: 0;
}

.bgimg-1, .bgimg-2, .bgimg-3, .bgimg-4 {
  position: relative;  
  left: 50%;
  right: 50%;
  margin-left: -50vw;
  margin-right: -50vw;
  max-width: 100vw;
  width: 100vw;
  background-attachment: fixed;
  background-position: center;
  background-repeat: no-repeat;
  background-size: cover;

}
.bgimg-1 {
  background-image: url('./ProjectProposal/ensemble.png');
  opacity: 0.9;
  background-size: contain;
  min-height: 400px;
}

.bgimg-2 {
  background-image: url('./ProjectProposal/bgimg12.png');  
  opacity: 0.65;
  min-height: 400px;
}

.bgimg-3 {
  background-image: url('./ProjectProposal/figure3.jpg');
  opacity: 0.9;
  min-height: 400px;
  -webkit-filter: blur(2px);
}

.bgimg-4 {
  background-image: url('./ProjectProposal/fbprophet.png');  
  opacity: 0.65;
  min-height: 400px;
}

.caption {
  position: absolute;
  left: 0;
  top: 50%;
  width: 100%;
  text-align: center;
  color: #000;
}

.caption span.border {
  background-color: #111;
  color: #fff;
  padding: 18px;
  font-size: 25px;
  letter-spacing: 10px;
  background-color:transparent;
}

/* Turn off parallax scrolling for tablets and phones */
@media only screen and (max-device-width: 1024px) {
  .bgimg-1, .bgimg-2, .bgimg-3 {
    background-attachment: scroll;
  }
}
.snip1143 {
  font-family: Arial, sans-serif;
  
  text-transform: uppercase;
  font-weight: 500;
}
.snip1143 * {
  box-sizing: border-box;
  text-align: left;
  -webkit-transition: all 0.35s ease;
  transition: all 0.35s ease;
}
.snip1143 li {  
  list-style: outside none none;
  margin: 0 1.5em;
  overflow: hidden;
}
.snip1143 a {
  padding: 0.3em 0;
  color: rgba(255, 255, 255, 0.5);
  position: relative;
  display: inline-block;
  letter-spacing: 1px;
  margin: 0;
  text-decoration: none;
}
.snip1143 a:before,
.snip1143 a:after {
  position: absolute;
  -webkit-transition: all 0.5s ease;
  transition: all 0.5s ease;
}
.snip1143 a:before {
  top: 100%;
  display: block;
  height: 3px;
  width: 100%;
  content: "";
  background-color: #34495E;
}
.snip1143 a:after {
  padding: 0.3em 0;
  position: absolute;
  top: 100%;
  left: 0;
  content: attr(data-hover);
  color: white;
  white-space: nowrap;
}
.snip1143 li:hover a,
.snip1143 .current a {
  transform: translateY(-100%);
}
.tooltip {
  position: relative;
  background: #708090;
  padding: 5px 8px;
  margin: 5px;
  font-size: 15px;
  border-radius: 100%;
  color: #FFF;
}

.tooltip:before,
.tooltip:after {
  position: absolute;
  content: '';
  opacity: 0;
  transition: all 0.5s ease;
}

.tooltip:before {
  border-width: 10px 8px 0 8px;
  border-style: solid;
  border-color: #424B54 transparent transparent transparent;
  top: -15px;
  transform: translateY(20px);
}

.tooltip:after {
  content: attr(data-tooltip);
  background: #424B54;
  width: 360px;
  height: 50px;
  font-size: 15px;
  font-weight: 300;
  top: -66px;
  left: -10px;
  padding: 10px;
  border-radius: 5px;
  letter-spacing: 1px;
  transform: translateY(20px);
}

.tooltip:hover::before,
.tooltip:hover::after {
  opacity: 1;
  transform: translateY(-2px);
}

@keyframes shake {
  0% { 
    transform: rotate(9deg);
  }
  30% {
   transform: rotate(-9deg);
  }
  50% {
    transform: rotate(5deg);
  }
  70% {
    transform: rotate(-5deg);
  }
  100% {
    transform: rotate(2deg);
  }
}

#anim:hover {
  animation: shake 1000ms ease-in-out forwards;
}

.tip {
  position: relative;
  background: transparent;
  font-size: inherit;
  border-radius: 100%;
  color: inherit;
}

.tip:before,
.tip:after {
  position: absolute;
  content: '';
  opacity: 0;
  transition: all 1.0s ease;
}

.tip:before {
  border-width: 10px 8px 0 8px;
  border-style: solid;
  border-color: #424B54 transparent transparent transparent;
  top: -15px;
  left: -50vw;
  transform: translateX(200px);
}

.tip:after {
  content: attr(data-tooltip);
  background: #6C7A89;
  width: 140px;
  height: 150px;
  font-size: 15px;
  font-weight: 300;
  top: -15px;
  left: -6vw;
  padding: 10px;
  border-radius: 5px;
  letter-spacing: 1px;
  transform: translateX(200px);
}

.tip:hover::before,
.tip:hover::after {
  opacity: 1;
  transform: translateX(-100px);
}


#animate:hover {
  animation: 1000ms ease-in-out forwards;
}
</style>
</head>
<body>

<body class="dark-theme">
<script src="./ProjectProposal/prism.js"></script>
<header class="header-module--header--tFeG9">
	<div class="header-module--inner--7ao1M">
		<div class="header-module--logo--2kX-3">
			<span class="header-module--text--3UAQj"> CS460: Machine Learning</span>
		</div>
		<span class="header-module--right--1Zeb6">
			<div class="menu-module--desktopMenuContainer--3iXKR">Dinesh Beniwal, Adittya Pal</div>
		</span>
	</div>
</header>
<div class="content"><div class="post-module--post--28Mq2"><div class="post-module--postContent--1bfnt">

<h1 class="post-module--title--3XBo2">CS460 : Final Report</h1>
<h2>Creating an AI bot to trade FOREX in the Stock Market</h2>
<div class="post-module--meta--3YtjE">8 September 2021</div>
<hr/>
Submitted as part of course requirements for CS460: Machine Learning, Fall 2021<br>
Offered by the School of Computer Sciences,<br>
National Institute of Science Education and Research,<br>
Bhubaneswar.<br>
<strong>Course Instructor: Dr. Subhankar Mishra</strong><br>
Faculty Mentor: Dr. Amarendra Das
<hr/>

<nav>
<h2>&emsp;&emsp; Index</h2>
<hr/>
<ul class="snip1143">
  <li><a href="./ProjectProposal/proposal.html" data-hover="Proposal">Proposal</a></li>
  <li><a href="./midway.html" data-hover="Midway Report">Midway Report</a></li>
  <li><a href="#Review" data-hover="Review: Till Now">Review</a></li>
  <li><a href="#Analysis" data-hover="Analysis">Analysis</a></li>
  <li><a href="#Leverage" data-hover="Betting with Leverage">Trading with Leverage</a></li>
  <li><a href="#Bot" data-hover="Creating the BOT">Creating the BOT</a></li>
  <li><a href="#Results" data-hover="Results">Results</a></li>
  <li><a href="#Relevant Papers" data-hover="Relevant Papers">Relevant Papers</a></li>
  <li><a href="https://github.com/AdittyaPal/21cs460_group13" data-hover="GitHub Repo">GitHub Repo</a></li>
</ul>
</nav>
<br>

<figure>
    <blockquote>
        <p><i>Meanwhile, sciences that involve human beings rather than elementary particles have proven more resistant to elegant mathematics. Economists suffer from physics envy over their inability to neatly model human behavior... But if that’s so, we should stop acting as if our goal is to author extremely elegant theories, and instead embrace complexity and make use of the best ally we have: the unreasonable effectiveness of data.</i></p>
    </blockquote>
    <figcaption style="text-align: right"><a href="https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/35179.pdf">—Alon Halevy et al. (2009)</a></figcaption>
</figure>

<h2 id="Review">Review: What's done till now...</h2>
<hr/>

<div style="position:relative;">
  <h3>Fitting of Models<div id="anim"><span class="tooltip" data-tooltip="what we have done till midway.">?</span>
  </div></h3>
  <ul>
  	<li style="list-style-type: square;">Collection of data from the <a href=""https://www.mql5.com/en/docs/integration/python_metatrader5>MetaTrader 5</a> and <a href="https://www.fxcm.com/fxcmpy/">FXCM</a> APIs. </li>
  	<li style="list-style-type: square;"><div id="animate"><span class="tip" data-tooltip="Linear Reg., Perceptron, Log. Reg., ARIMA, fbProphet">Fitting of models based on <a href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LinearRegression.html">linear regression</a>, <a href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LogisticRegression.html">logistic regression</a>, <a href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.Perceptron.html">perceptron</a>, AutoRegressive Integrated Moving Averages <a href="https://alkaline-ml.com/pmdarima/index.html">(ARIMA)</a> and <a href="https://facebook.github.io/prophet/">facebook Prophet</a>.</span>
  </div></li>
  	<li style="list-style-type: square;">The ARIMA model was the most accurate model of all the five considered. However, it was also the one which took the longest to train and the longest to predict future tick values of the exchange rate.</li>
  	<li style="list-style-type: square;">Training on the model and testing of the model on separate sets of data, to verify whether the trading-strategies actually work.</li>
  </ul>
  <p><a href="./midway.html">Midway Report</a></p>
  <br/>
  <p>We tried a <a href="https://scikit-learn.org/stable/modules/tree.html">decision tree</a> model too in addition to the above mentioned models. We chose the decision tree based model to be the underlying algorithm behind out trading bot because :</p>
  <ul style="list-style: circle;">
  	<li>Trees require minimal data cleaning operations. They work without normalisation, and often with missing values too.</li>
  	<li>A decision tree construction takes \(\mathcal{O}(2^n)\) time, but once a decision tree has been constructed, reaching the decision is fast as it takes \(\mathcal{O}(log(n))\) time.</li>
  	<li>Overfitted trees can be dealt with ensemble methods.</li>
  	<li>Effect of small variations in the data might also be overcome by using ensemble methods.</li>
  </ul>
  <p>Creating a decision tree with scikit learn's <a href="https://scikit-learn.org/stable/modules/generated/sklearn.tree.DecisionTreeClassifier.html">sklearn.tree.DecisionTreeClassifier</a>, the main hyperparameter to fit was the depth of the tree using this <a href="https://github.com/AdittyaPal/21cs460_group13/blob/1c101c2d3e8548400840ba3708bf36d270d407bd/formal%20code/tree_test.py">script<a/>.</p>
  <ul style="list-style: circle;">
  	<li>Gini impurity was used as the criterion to decide which feature should be used to split each node.</li>
  	<li>A leaf node would have at most 15 samples. If the number of samples is more than 15 in a node, it is attempted to split that node.</li>
  	<li>The depth of the tree was decided by trial and error.</li>
  </ul>
  <p><img src="./ProjectProposal/Figure_tree.png" alt="Effect of depth"></p>
  </br>
  <p>The performance of decision trees with varying depths is summarized in the table below.</p>
  <table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Tree Depth</th>
      <th>Train Accuracy</th>
      <th>Test Accuracy</th>
      <th>Number of trades</th>
      <th>Gross Performance</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>2</td>
      <td>0.568</td>
      <td>0.533</td>
      <td>973</td>
      <td>1.003</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.586</td>
      <td>0.534</td>
      <td>925</td>
      <td>1.011</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.593</td>
      <td>0.535</td>
      <td>91179</td>
      <td>1.008</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.605</td>
      <td>0.547</td>
      <td>1415</td>
      <td>1.007</td>
    </tr>
    <tr>
      <td>10</td>
      <td>0.672</td>
      <td>0.532</td>
      <td>3391</td>
      <td>1.004</td>
    </tr>        
  </tbody>
</table>
<p>Therefore, a tree with depth <i>three</i> gives the best performance.</p>
  
 </br>
</div>
<h2 id="Analysis">Analysis: Can we do better...</h2>
<hr/>
<figure>
    <blockquote>
        <p><i>History never repeats itself, but it rhymes.</i></p>
    </blockquote>
    <figcaption style="text-align: right"><a href="https://www.owu.edu/news-media/owu-magazine/fall-2018/history-doesnt-repeat-itself-but-it-often-rhymes/">—Mark Twain</a></figcaption>
</figure>
	
<h3>Normalization<div id="anim"><span class="tooltip" data-tooltip="Does making the feature set more consistent help?">?</span>
  </div></h3>
  <p>The features were normalized so that no feature is arbitrarily large and all features are of the same scale. The magnitude of no feature has an undue influence on the prediction of the future exchange rate and the best possible classification is obtained.</p>
  <ul style="list-style: circle;">
  	<li>Centering : The entire feature set is shifted so that it is centred around the mean.
  	<p>$$x_{n, d} \leftarrow x_{n, d}-\mu_d$$</p></li>
  	<li>Variance scaling : The feature set has a variance of one across the input data used for training the model
  	<p>$$x_{n, d} \leftarrow \frac{x_{n, d}}{\sigma_d}$$</p></li>  	
  </ul>
<pre><code class="language-python">
mu=np.mean(dataLags, axis=0)
std=np.std(dataLags, axis=0)
normalisedData=(dataLags-mu)/std

</code></pre>
</br>
  <p style="text-align: justify;">With the increase in the number of features, the testing accuracy of the model increases along with an increase in the performance of the model.</p>
<pre><code class="language-python">Output:
Without Normalisation:
Training Accuracy
0.571375
Testing Accuracy
0.5448328267477204
With Normalisation:
Training Accuracy
0.57075
Testing Accuracy
0.5531914893617021
No. of trades :
Without Normalisation : 1153
With Normalisation :    221
Gross Performance :
returns                1.000563
strategy_No_Norm       1.000555
strategy_Normalised    1.002912
dtype: float64

</code></pre>
	<p><img src="./ProjectProposal/Figure_normalise.png" alt="Effect of Normalisation"></p>
	<p style="text-align: justify;">With normalisation, the performance of the model becomes more consistent (red line) as compared to without normalisation (green line). The blue line is the base returns.</p>
</br>	
<h3>Feature Engineering<div id="anim"><span class="tooltip" data-tooltip="Does increasing the number of features to predict from help?">?</span>
  </div></h3>
  <p>Earlier <i>lag</i> number of immediately preceding values of the exchange rate was being used for the prediction of the future exchange rate. The feature vector set was expanded by engineering the following features:</p>
  <ul style="list-style: circle;">
  	<li>Rolling volatility of the exchange rate for the immediately preceding rolling window using <a href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.std.html">pandas.DataFrame.std()</a></li>
  	<li>Momentum of the exchange rate as the mean for the immediately preceding rolling window using <a href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.mean.html">pandas.DataFrame.mean()</a></li>
  	<li>Minimum value of the exchange rate in the immediately preceding window values using <a href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.min.html">pandas.DataFrame.min()</a></li>
  	<li>Maximum value of the exchange rate in the immediately preceding window values using <a href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.max.html">pandas.DataFrame.max()</a></li>
  </ul>
<pre><code class="language-python">
raw['returns'] = np.log(raw / raw.shift(1))
window=20
raw['vol']=raw['returns'].rolling(window).std()
raw['mom']=raw['returns'].rolling(window).mean()
raw['sma']=raw['close'].rolling(window).mean()
raw['min']=raw['close'].rolling(window).min()
raw['max']=raw['close'].rolling(window).max()
raw['direction']=np.where(raw['returns']>0, 1, -1)
self.data = raw.dropna()

</code></pre>
</br>
  <p style="text-align: justify;">With the increase in the number of features, the testing accuracy of the model increases along with an increase in the performance of the model.</p>
<pre><code class="language-python">Output:
Without Feature Engineering:
Training Accuracy
0.57275
Testing Accuracy
0.5466058763931104
With Feature Engineering:
Training Accuracy
0.57075
Testing Accuracy
0.5531914893617021
No. of trades :
Without Feature Engineering: 924
With Feature Engineering:    221
Gross Performance :
returns             1.000563
strategy_No_Engg    0.998158
strategy_FEngg      1.002912
dtype: float64

</code></pre>
	<p><img src="./ProjectProposal/Figure_FEngg.png" alt="Effect of Feature Engineering"></p>
	<p style="text-align: justify;">With feature engineering, the performance of the model improves (red line) as compared to without feature engineering (green line). The blue line is the base returns.</p>
	<p style="text-align: justify;">For the comparison of the effects of normalisation and feature engineering on the performance of the model, they are plotted on the same graph using this <a href="https://github.com/AdittyaPal/21cs460_group13/blob/1c101c2d3e8548400840ba3708bf36d270d407bd/formal%20code/data_engineer.py">script</a>.</p>
	<p><img src="./ProjectProposal/Figure_data.png" alt="Effect of data manipulation"></p>
	<p>The table here lists the relevant performance parameters.</p>
	<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Condition</th>
      <th>Train Accuracy</th>
      <th>Test Accuracy</th>
      <th>Number of trades</th>
      <th>Gross Performance</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Feature Engineering only</td>
      <td>0.571</td>
      <td>0.545</td>
      <td>1153</td>
      <td>1.0005</td>
    </tr>
    <tr>
      <td>Normalization only</td>
      <td>0.573</td>
      <td>0.547</td>
      <td>942</td>
      <td>0.998</td>
    </tr>
    <tr>
      <td>Both</td>
      <td>0.605</td>
      <td>0.553</td>
      <td>221</td>
      <td>1.003</td>
    </tr>        
  </tbody>
</table>
	<p style="text-align: justify;">Both feature engineering and normalization increase the testing accuracy and decrease the number of trades performed.</p>
</br>
<div class="bgimg-1">
  <div class="caption">
  <span class="border" style="color: #CF000F; font-size: 30px;">ENSEMBLE METHODS</span>
  </div>  
</div>

<h3>Bagging<div id="anim"><span class="tooltip" data-tooltip="Does introducing some randomness in the construction of the model help?">?</span>
  </div></h3>
  <p><a href="https://scikit-learn.org/stable/modules/ensemble.html#bagging-meta-estimator">Bagging</a> creates several instances of the model classifier (decision tree in this case) which are trained on random subsets of the training data. A voted average of the individual classification predictions is taken as the net prediction. Bagging tries to reduce the variance and avoid overfitting of the decision tree by introducing randomness in the construction of the decision tree.</p>
  <p>Bagging with its promise of reducing variance bring a host of other hyperparameters. We used scikit-learn's <a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.BaggingClassifier.html">sklearn.ensemble.BaggingClassifier()</a> with the following hyperparameters</p>
  <ul style="list-style: circle;">
  	<li>Base estimator is a decision tree with height three and at least fifteen data points for it to be a leaf node</li>
  	<li>100 base estimators in the ensemble</li>
  	<li>Train the decision tree on the entire training dataset</li>
  	<li>Out of the available 36 features, use some random 24 of them to construct the decision tree</li>
  </ul>
<pre><code class="language-python">
from sklearn.tree import DecisionTreeClassifier
from sklearn.ensemble import BaggingClassifier

maxDepth=3
minSamplesLeaf=15
subsample=0.33
nEstimators=15
maxSamples=1.0
maxFeatures=0.75
randomState=100

tree=DecisionTreeClassifier(random_state=randomState, max_depth=maxDepth, min_samples_leaf=minSamplesLeaf)
model=BaggingClassifier(base_estimator=tree, n_estimators=nEstimators, max_samples=maxSamples, max_features=maxFeatures, random_state=randomState)

</code></pre>
</br>
  <p style="text-align: justify;">Bagging increases the performance of the model slightly in the near future but lags behind farther in the future.</p>
<pre><code class="language-python">Output:
Without Bagging :
Training Accuracy
0.5856
Testing Accuracy
0.5335348301669545
With Bagging :
Training Accuracy
0.5856
Testing Accuracy
0.5533966609096143
No. of trades :
Without Bagging :   925
With Bagging    :  1069
Gross Performance :
returns             0.994459
strategy_No_Bag     1.011918
strategy_Bagging    1.018981
dtype: float64

</code></pre>
	<p><img src="./ProjectProposal/Bagging.png" alt="Effect of Bagging"></p>
	<p style="text-align: justify;">Using bagging, the performance of the model becomes better initially (red line) but suffers a little setback (after an abrupt fluctuation in the exchange rate around the tick point 8500). Overall the performance with bagging is better than the performance without bagging (green line). The blue line is the base returns.</p>
</br>

<h3>Boosting<div id="anim"><span class="tooltip" data-tooltip="Does fitting an ensemble of weak learners on the data work?">?</span>
  </div></h3>
  <p><a href="https://scikit-learn.org/stable/modules/ensemble.html#adaboost">Boosting</a> tries to fit an ensemble of weak learners (models with high bias) on the training data, whose predictions are aggregated to get the final prediction. At each iteration, the weights for the training data points, whose labels are incorrectly predicted by the model, are increased and the model is focussed to learn from the data points it has failed to predict correctly.</p>
  <p>Boosting again introduces a host of other hyperparameters. We used scikit-learn's <a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.AdaBoostClassifier.html#sklearn.ensemble.AdaBoostClassifier">sklearn.ensemble.AdaBoostClassifier()</a> with the following hyperparameters</p>
  <ul style="list-style: circle;">
  	<li>Base estimator is a decision tree with height three and at least fifteen data points for it to be a leaf node</li>
  	<li>15 base estimators in the ensemble</li>
  </ul>
<pre><code class="language-python">
from sklearn.tree import DecisionTreeClassifier
from sklearn.ensemble import AdaBoostClassifier

nEstimators=15
randomState=100
maxDepth=3
minSamplesLeaf=15
subsample=0.33

tree=DecisionTreeClassifier(random_state=randomState, max_depth=maxDepth, min_samples_leaf=minSamplesLeaf)
model=AdaBoostClassifier(base_estimator=tree, n_estimators=nEstimators, random_state=randomState)

</code></pre>
</br>
  <p style="text-align: justify;">With boosting the performance of the trading model trails the gross performance of a single decision tree.</p>
<pre><code class="language-python">Output:
Without Boosting:
Training Accuracy
0.5856
Testing Accuracy
0.5335348301669545
With Boosing:
Training Accuracy
0.8294
Testing Accuracy
0.5063327576280944
No. of trades :
Without Boosting : 925
With Boosting    : 4721
Gross Performance :
returns              0.994459
strategy_No_Boost    1.011918
strategy_Boosting    1.006535
dtype: float64

</code></pre>
	<p>As one can see, boosting increases the training accuracy significantly but the testing accuracy does not increase. It shows that, with boosting the model <i>overfits</i> the training data. Hence, boosting is not applicable in our case. The model has a high <i>bias</i> and boosting does not help in reducing that.</p>
	<p><img src="./ProjectProposal/Figure_Boost.png" alt="Effect of Boosting"></p>
	<p style="text-align: justify;">With boosting (red line), the performance of the strategy trails the gross performance of the decision tree. The blue line is the base returns.</p>
</br>

<h3>Random Forest<div id="anim"><span class="tooltip" data-tooltip="Does introducing randomness during the decision taking help?">?</span>
  </div></h3>
  <p><a href="https://scikit-learn.org/stable/modules/ensemble.html#random-forests">Random Forests</a> tries to decrease the variance and prevent overfitting of the model. Random errors in the predictions from the decision trees might cancel, and reduce the variance.</p>
  <p>Using scikit-learn's <a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestClassifier.html">sklearn.ensemble.RandomForestClassifier()</a> with the following hyperparameters</p>
  <ul style="list-style: circle;">
  	<li>Base estimator is a decision tree with height three and at least ten data points for it to be a leaf node</li>
  	<li>100 base estimators in the ensemble</li>
  	<li>0.80 part of the sample was used for the training of each tree</li>
  </ul>
<pre><code class="language-python">
from sklearn.ensemble import RandomForestClassifier

nEstimators=100
randomState=100
maxDepth=3
minSamplesLeaf=10
maxSamples=0.80

model=RandomForestClassifier(n_estimators=nEstimators, max_depth=maxDepth, max_samples=maxSamples, min_samples_leaf=minSamplesLeaf, random_state=randomState)

</code></pre>
</br>
  <p style="text-align: justify;">Using a random forest does increase the performance of the model.</p>
<pre><code class="language-python">Output:
Using a single Decision tree:
Training Accuracy
0.5866
Testing Accuracy
0.5367012089810017
Using a Random Forest:
Training Accuracy
0.5788
Testing Accuracy
0.5533966609096143
No. of trades :
With single tree   : 873
With random forest : 565
Gross Performance :
returns                   0.994459
strategy_Tree             1.013235
strategy_Random_Forest    1.013452
dtype: float64

</code></pre>
	<p><img src="./ProjectProposal/Figure_Forest.png" alt="Effect of Random Forest"></p>
	<p style="text-align: justify;">Using a random forest, the performance of the model (red line) becomes slightly better than the performance with a single decision tree (green line). The blue line is the base returns.</p>
	<p style="text-align: justify;">Again for the purposes of comparison using this <a href="https://github.com/AdittyaPal/21cs460_group13/blob/1c101c2d3e8548400840ba3708bf36d270d407bd/formal%20code/ensemble_methods.py">script</a>, the performance of the three ensemble methods have been plotted in a single graph and their performance parameters listed in the table below.</p>
	<p><img src="./ProjectProposal/Figure_ensemble.png" alt="Effect of Ensemble methods"></p>
	<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ensemble Method</th>
      <th>Train Accuracy</th>
      <th>Test Accuracy</th>
      <th>Number of trades</th>
      <th>Gross Performance</th>
    </tr>
  </thead>
  <tbody>
  	<tr>
      <td>Single Tree</td>
      <td>0.5856</td>
      <td>0.5335</td>
      <td>925</td>
      <td>1.0119</td>
    </tr>
    <tr>
      <td>Bagging</td>
      <td>0.5834</td>
      <td>0.5532</td>
      <td>793</td>
      <td>1.0128</td>
    </tr>
    <tr>
      <td>Boosting</td>
      <td>0.6452</td>
      <td>0.5332</td>
      <td>3901</td>
      <td>1.0097</td>
    </tr>
    <tr>
      <td>Random Forest</td>
      <td>0.5788</td>
      <td>0.5534</td>
      <td>565</td>
      <td>1.0134</td>
    </tr>        
  </tbody>
</table>
	<p style="text-align: justify;">Bagging and Random forests increase the performance and the testing accuracy by decreasing the variance of the single estimators (a decision tree which usually has high variance). Boosting <i>overfits</i> the training data resulting in high training accuracy but poor performance and a huge number of trades are incurred.</p>
</br>
</br>
<h2 id="Leverage">Leverage: Turn on the heat...  Raise the bar...<div id="anim"><span class="tooltip" data-tooltip="Leverage is number by which brokers offer to scale profits and losses by.">?</span>
  </div></h2>
<hr/>
<figure>
    <blockquote>
        <p><i>Financial institutions like to call what they do trading. Let’s be honest. It’s not trading; it’s betting.</i></p>
    </blockquote>
    <figcaption style="text-align: right">—Graydon Carter</figcaption>
</figure>
	<p style="text-align: justify;"><div id="animate"><span class="tip" data-tooltip="Non-leveraged returns from FOREX are low, due to small fluctuations.">Without <a href="https://www.investopedia.com/articles/forex/07/forex_leverage.asp">leverage</a>, calculation of the returns is simple and uninteresting, the small fluctuations of the exchange rate between a pair of currencies do not generate high profits. Suppose &euro;1000 is bought at an exchange rate of 1.115 with respect to the US Dollar. If the exchange rate increases to 1.118 then the absolute profit would be \((1.118-1/115)\times 1000=0.003\times 1000 =\) &euro;3 or \(0.3 \%\).</span></div></p>
	<p style="text-align: justify;"><div id="animate"><span class="tip" data-tooltip="Leverage multiplies the returns, for decent profits. P = Ret. x Lev.">With a leverage of say \(50:1\), the profit would be \(3\times 50=\)&euro;150 or \(1.5 \%\). The profits get multiplied by a factor of 50, and so do any losses if incurred.</span></div> <div id="animate"><span class="tip" data-tooltip="Leverage amplifies loss. For a loss of Capital/Leverage, entire amount is forfeited.">Even if a loss of &euro;20 is incurred, then loss would be \(20\times 50\)=&euro;1000 and the entire starting capital is forfeited. Trading with <a href="https://www.investopedia.com/ask/answers/06/forexleverage.asp">leverage amplifies potential profits and also AMPLIFIES potential LOSSES</a>.</span></div></p>
	<p style="text-align: justify;"><div id="animate"><span class="tip" data-tooltip="Solution: Trade with an opimal leverage that scales profits, with reasonable risks.">Now the question arises, what is the optimal leverage that maximizes the long term returns without incurring too much risks. Kelly criterion allows the calculation of that. As it involves too much mathematics, it is done as an <a href="./ProjectProposal/kelly.html">aside</a>.</span></div></p>
	<p><img src="./ProjectProposal/Figure_lev.png" alt="Effect of leverage"></p>
	<p style="text-align: justify;">As shown in the graph, leverage might increase profits, but it also increases losses (like it does at the end of the testing period). It makes markets choppy.</p>
<figure>
    <blockquote>
        <p><i>High Risk Investment Notice:
        
        CFDs are complex instruments and come with a high risk of losing money rapidly due to leverage.

67% of retail investor accounts lose money when trading CFDs with this provider.

You should consider whether you understand how CFDs work and whether you can afford to take the high risk of losing your money.

Trading Forex/CFDs on margin carries a high level of risk and may not be suitable for all investors.</i></p>
    </blockquote>
</figure>
	<p style="text-align: justify;">After the log returns were calculated, its mean and variance values were calculated and the optimal leverage was determined as $$f=\frac{Mean}{Variance}$$ For the duration of 5000 minutes, the optimal leverage was calculated as 10:1 for the trading strategy adopted.</p>
<pre><code class="language-python">
Optimal Leverage by full Kelly criterion:
returns      -13.894910
strategy    1885.394094
dtype: float64
Optimal Leverage by half Kelly criterion:
returns     -0.075079
strategy    10.101941
dtype: float64

</code></pre>
	<p style="text-align: justify;">With the application of leverage, the risks increase. To quantify the risks the <a href="https://www.investopedia.com/terms/m/maximum-drawdown-mdd.asp"><i>maximum drawdown</i></a> and the <i>longest drawdown period</i> (longest period between two consecutive highs of the returns) is calculated. Values of these two parameters on the testing data is indicative and no guarantee for future performances.</p>
	<p style="text-align: justify;">With introducing leverage, returns become more volatile, they fluctuate more. Maximum <a href="https://en.wikipedia.org/wiki/Drawdown_(economics)">drawdown</a> is the largest difference between a previous high in returns and the current returns. It quantifies the maximum losses that might be incurred after making some profits, or the profits that might be eaten up due to bad market movements. The longest drawdown period is the longest duration the model takes to do better than its previous high. As an aside, <a href="https://asia.nikkei.com/Spotlight/Datawatch/30-years-since-Japan-s-stock-market-peaked-climb-back-continues">Japan’s Nikkei stock index</a> has its drawdown period at 277 months (and counting) - older than me. </p>

<pre><code class="language-python">
Maximum Drawdown     : 0.20560
Max. Drawdown period : 298 mins

</code></pre>
	<p><img src="./ProjectProposal/leverage.png" alt="Leverage and Risks"></p>
	<p style="text-align: justify;">The drawdown would be the difference between the current rate (blue line) and the cumulative maximum of the return rate (green line). The maximum drawdown of 0.20560 occurs at the position denoted by the vertical red line. The drawdown periods are denoted by the horizontal green lines.</p>
	<p style="text-align: justify;">The <a href="https://www.investopedia.com/terms/v/var.asp"><i>value-at-risk</i></a> was calculated as the maximum amount of capital that might be expected to be lost in the considered time frame of trading, quoted with a certain confidence level.</p>
<pre><code class="language-python">
Level of Confidence              Value Risked
--------------------------------------------------
          99.99 %                6.057
          99.90 %                3.192
          99.00 %                1.705
          97.50 %                1.275
          95.00 %                0.937
          90.00 %                0.597

</code></pre>	
	<p style="text-align: justify;">So, under the tested conditions one can be sure with \(99.99\%\) that the losses would not exceed &euro;6 for the duration of trading using the given model. $$Value-at-risk = Percentile\,of\,returns \times capital$$ <div id="animate"><span class="tip" data-tooltip="Equivalent to calculating sum of probablities or area-under-curve to the left of red line.">As a starting capital of &euro;1000 was assumed for the trading position, one can say with \(99\%\) confidence that an amount of \(0.0017\times 1000 =\) &euro;1.7 would be lost during the process of trading.</span></div></p> 
	<p><img src="./ProjectProposal/Figure_hist.png" alt="Distrubuion of returns"></p>
	<p style="text-align: justify;">Before trading in a pair of currencies, the parameters for managing risks have to be set properly to avoid losses. The <i>maximum drawdown</i> and <i>value-at-risk</i> determined here using this <a href="https://github.com/AdittyaPal/21cs460_group13/blob/1c101c2d3e8548400840ba3708bf36d270d407bd/formal%20code/leverage.py">script</a> are <i>directed risk measures</i> - they quantify losses only as opposed to <i>volatility</i> which is an undirected risk measure - it is high both when exchange rates appreciate or depreciate.</p>  
</br>
<h2 id="Bot">Creating the BOT</h2>
<hr/>
<p style="text-align: justify;">The testing does till now does not mimic the real life trading process because: </p>
	<ul style="list-style: circle;">
  	<li>Look ahead bias - The complete testing data is available to the testing class beforehand, while in real life data arrives periodically and bit-by-bit as ticks, which is recified in this <a href="https://github.com/AdittyaPal/21cs460_group13/blob/26edd685449b1236ee934cb6608370f5d0c5acd8/formal%20code/backtest.py">script</a>.</li>
  	<li>Event based decisions cannot be taken to minimize risks associated with trading. The decision is taken as the data arrives.</li>
  	<li>Speed of execution of the entire trading process - streaming of live data, processing in real time and executing a decision within a minute is necessary for executing one-minute trades.</li>
  </ul>
<figure>
    <blockquote>
        <p><i>People worry that computers will get too smart and take over the world, but the real problem is that they’re too stupid and they’ve already taken over the world.</i></p>
    </blockquote>
    <figcaption style="text-align: right"><a href="https://www.washington.edu/news/2015/09/17/a-q-a-with-pedro-domingos-author-of-the-master-algorithm/">—Pedro Domingos<a/></figcaption>
</figure>
<div class="bgimg-2">
  <div class="caption">
  <span class="border" style="color: #F7CA18; font-size: 30px;">RISK ANALYSIS</span>
  </div>  
</div>
	</br>
	<p style="text-align: justify;">To reduce risks while trading we stop losses, and take profits, by comparing the current volatility to the <a href="https://www.investopedia.com/articles/trading/08/average-true-range.asp"><i>average true range</i><a/> over the last thirty minutes usimg this <a href="https://github.com/AdittyaPal/21cs460_group13/blob/1c101c2d3e8548400840ba3708bf36d270d407bd/formal%20code/atr.py">script</a>. $$True\,Range=Max[(High-Low), Abs(High-Close), Abs(Close-Low)]$$ $$Average\,True\,Range=\frac{1}{n}\sum_{i=1}^{n} (True\,Range)_i$$</p>
<pre><code class="language-python">
win=30
price['min']=price['close'].rolling(win).min()    #rolling minimum
price['max']=price['close'].rolling(win).max()    #rolling maximum
price['range']=price['max']-price['min']              #difference between the rolling maximum and minimum
price['maxToday']=abs(price['max']-price['close'].shift(1))  #difference between the rolling maximum and the previous day's closing price
price['minToday']=abs(price['min']-price['close'].shift(1))  #difference between the rolling minimum and the previous day's closing price
price['atr']=np.maximum(price['range'], price['maxToday'])   #calculate the greater value of the max-min range and the max-price difference
price['atr']=np.maximum(price['atr'], price['minToday'])     #and min-price difference
price['atr%']=price['atr']/price['close']

</code></pre>
	<p><img src="./ProjectProposal/Figure_atr.png" alt="Average True returns"></p>
	<p>The absolute and relative average true returns do not differ much in the plot here as the closing values of the exchange rate remained around 1 in the selected interval.</p>
	<p style="text-align: justify;"><div id="animate"><span class="tip" data-tooltip="To protect from large changes, the model is constrained to operate in a band of rates.">The <i>stop loss</i> and <i>take profit</i> levels should be set according to the <i>average true range</i> values. If the stop loss level is set too low then the model stops trading while encountering typical movements in the exchange rate, whereas the objective of the stop loss is to protect from large unfavourable movements in the exchange rate and not noise. If the take profit level is set too high then the model might lose profits earned due to unfavourable market movements.</span></div></p>
</br>
<h3>Stop Loss</h3><hr/>
	<p style="text-align: justify;"><div id="animate"><span class="tip" data-tooltip="When ex. rates dip, stop loss. Protect the value and use it when ex. rates rise.">On reaching a certain loss amount, the foreign exchange is sold out to start afresh. If The stop loss is set at \(2\%\), then if the exchange rate deprecates from 100 to 98, then the entire amount is sold to arrest further losses (it is anticipated that the exchange rate might fall further). Similarly, on the other hand, if the exchange rate appreciates from 100 to 102, then the currency is bought with the available capital to not lose out potential profits (again anticipated that the momentum will stay).</span></div></p>
<pre><code class="language-python">
#check whether stop loss rate has been defined, and the trader has started trading
if self.sl!=0 and self.position!=0:
	#calculate the difference of current exchange rate from the initial exchange rate
	change=(price-self.entryPrice)/self.entryPrice
		#if the loss incurred is greater than the acceptable loss set by stopLoss()
		if change<-self.sl and self.position==1:
			print(60*'-')
			print('--- STOP LOSS (LONG | -{self.sl}) ---')
			#sell off the forex held, anticipating still lower exchange rate
			self.go_short(bar-1, units=self.units)
			#set the market position to short (sold)
			self.position=-1
		#if the exchange rate is higher than expectations
		elif change>self.sl and self.position==-1:
			print(60*'-')
			print('--- STOP LOSS (SHORT | -{self.sl}) ---')
			#buy that forex, anticipating higher exchange rate in future 
			self.go_long(bar-1, units=self.units)
			#set the market position to long (bought)
			self.position=1

</code></pre>
</br>
<h3>Take Profit</h3><hr/>
	<p style="text-align: justify;"><div id="animate"><span class="tip" data-tooltip="Sell when ex. rates are high, before drop, to make profits. Don't expect higher rates.">When a certain level of profit is reached, the take profit order monetizes all the assets. If some certain amount of foreign exchange is bought when the exchange rate was 100, then the take profit order with a rate of \(5\%\) monetizes all the profits when the exchange rate appreciates to 105 (with the expectation that the exchange rate is too high, and might fall any time).</span></div> <div id="animate"><span class="tip" data-tooltip="Buy when ex. rates are low expecting them to rise. Look out for low rates.">Also, if the take profit order notices an unusually low exchange rate, 95 in this case, then it would buy a certain units of the foreign exchange with the available capital, with the expectation that exchange rate would appreciate leading possible profits (the rate is too low, and will revert to the mean value soon in future).</span></div></p>
<pre><code class="language-python">
#check whether take profit rate has been defined, and the trader has started trading
if self.tp!=0 and self.position!=0:
	#calculate the difference of current exchange rate from the initial exchange rate
	change=(price-self.entryPrice)/self.entryPrice
	#if the exchange rate is higher than that set by takeProfit()
	if change>self.tp and self.position==1:
		print(60*'-')
		print('--- TAKE PROFIT (LONG | -{self.sl}) ---')
		#sell off that currency to monetize the profit, anticipating a fall
		self.go_short(bar-1, units=self.units)
		#set the market position to short (sold)
		self.position=-1
	#if the exchange rate is lower than expectations
	elif change<-self.tp and self.position==-1:
		print(50*'-')
		print('--- TAKE PROFIT (SHORT | -{self.sl}) ---')
		#buy that forex, anticipating higher exchange rate in future
		self.go_long(bar-1, units=self.units)
		#set the market position to long (bought)
		self.position=1
					
</code></pre>
</br>
<h3>An Online Environment</h3><hr/>
	<p style="text-align: justify;">In real life, data has to be streamed and processed in real time. We tried to replicate that environment for the testing of our models using the <a href="https://zeromq.org/languages/python/">ZeroMQ</a> library for the Python language. A data server was created to publish the exchange rate data, and clients were created to receive the data. This fits the <a href="https://learning-0mq-with-pyzmq.readthedocs.io/en/latest/pyzmq/patterns/pubsub.html"><i>publisher-subscriber</i><a/> pattern where the data is published by a single socket and retrieved by multiple sockets simultaneously in 'real' time.</p>
<pre><code class="language-python">
import zmq
import time

contextObj = zmq.Context()
socketObj = contextObj.socket(zmq.PUB)
socketObj.bind('tcp://0.0.0.0:5555')

...

tickval=0
while tickval<7000:
    tick='{} {}'.format('close', data_send[tickval])
    socketObj.send_string(tick)
    time.sleep(5+random.random())
    tickval+=1
					
</code></pre>
	<p style="text-align: justify;">Instantiating a Context object with a socket of the PUB type for the server, bound to a local IP with port 5555 (tcp://0.0.0.0:5555), the data server was created to send data at the interval of around 5 seconds, using this <a href="https://github.com/AdittyaPal/21cs460_group13/blob/1c101c2d3e8548400840ba3708bf36d270d407bd/formal%20code/tick_server.py">script</a>. For the client, another Context object was instantiated, connected to the socket of the publishing the data (tcp://0.0.0.0:5555) and subscribed to the required channel, from this <a href="https://github.com/AdittyaPal/21cs460_group13/blob/e1e1d9905522ac7c57ceccc05a0ba1ba8c69be9c/formal%20code/tick_client.ipynb">Jupyter Notebook</a>. </p>
<pre><code class="language-python">
contextObj = zmq.Context()
socketObj = contextObj.socket(zmq.SUB)
socketObj.connect('tcp://0.0.0.0:5555')
socketObj.setsockopt_string(zmq.SUBSCRIBE, 'close')
received=socketObj.recv_string()
sym, val=received.split()
val=float(val)
					
</code></pre>

</br></br>
<h2 id="#Results">Results: Deploying the bot</h2>
<hr/>

<figure>
    <blockquote>
        <p><i>Considerable progress is needed before autonomous vehicles can operate reliably in mixed urban traffic, heavy rain and snow, unpaved and unmapped roads, and where wireless access is unreliable. Years of testing and regulatory approval will be required... autonomous vehicles are likely to be expensive and limited in performance. They will introduce new costs and risks. These constraints will limit sales. Many motorists will be reluctant to pay thousands of extra dollars for vehicles that will sometimes be unable to reach a destination due to inclement weather or unmapped roads.</i></p>
    </blockquote>
    <figcaption style="text-align: right">——<a href="https://www.vtpi.org/avip.pdf#%5B%7B%22num%22%3A40%2C%22gen%22%3A0%7D%2C%7B%22name%22%3A%22XYZ%22%7D%2C69%2C720%2C0%5D">Todd Litman</a></figcaption>
</figure>
  <div style="text-align: justify;">
  	<p>Online trading platforms allow streaming of financial data. Machine learning has been used to predict the direction of exchange rate movements. Can they be put together to work as an autonomous unit? We have tried that here.</p>
  	<h3>A (hopefully new) Model</h3>
  	<p>We had tried several models, each performing better in a certain condition. On an average, non-linear models (decision tree, k-nearest neighbours) performed better than linear models (regression, perceptron). However, in the real world the market confronts us with a host of scenarios. To confront each scenario, we built a <i>grand ensemble</i> of models consisting of</p>
	<ul style="list-style: circle;">
  		<li><a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.BaggingClassifier.html">sklearn.ensemble.BaggingClassifier</a> consisting of an ensemble of 100 decision trees estimators of <a href="https://scikit-learn.org/stable/modules/generated/sklearn.tree.DecisionTreeClassifier.html">sklearn.tree.DecisionTreeClassifier</a></li>
  		<li><a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.AdaBoostClassifier.html">sklearn.ensemble.AdaBoostClassifier</a> consisting of an ensemble of 15 decision tree instances of <a href="https://scikit-learn.org/stable/modules/generated/sklearn.tree.DecisionTreeClassifier.html">sklearn.tree.DecisionTreeClassifier</a></li>
  		<li><a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestClassifier.html">sklearn.ensemble.RandomForestClassifier</a> consisting of 100 decision trees</li>
  		<li><a href="https://scikit-learn.org/stable/modules/generated/sklearn.neighbors.KNeighborsClassifier.html">sklearn.neighbors.KNeighborsClassifier</a> with n_neighbours=2</li>
  		<li><a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.HistGradientBoostingClassifier.html">sklearn.ensemble.HistGradientBoostingClassifier</a> iterated over 100 decision trees</li>
  	</ul>
  	<p>Initially we had thought of using the <a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.VotingClassifier.html#">VotingClassifier</a> but that did not give good results. Instead, if any one of the models outputs a +1 label, the predicted label is assumed to be +1.</p>
<pre><code class="language-python">
from sklearn.tree import DecisionTreeClassifier
from sklearn.ensemble import BaggingClassifier
from sklearn.ensemble import AdaBoostClassifier
from sklearn.neighbors import KNeighborsClassifier
from sklearn.ensemble import RandomForestClassifier
from sklearn.ensemble import HistGradientBoostingClassifier

nEstimators=100
maxSamples=1.0
maxFeatures=0.75
randomState=100
maxSepth=3
minSamplesLeaf=15
subsample=0.33

tree=DecisionTreeClassifier(random_state=randomState, max_depth=maxDepth, min_samples_leaf=minSamplesLeaf)
model1=BaggingClassifier(base_estimator=tree, n_estimators=nEstimators, max_samples=maxSamples, max_features=maxFeatures, random_state=randomState)
model2=AdaBoostClassifier(base_estimator=tree, n_estimators=15, random_state=randomState)
model3=RandomForestClassifier(n_estimators=nEstimators, max_depth=maxDepth, max_samples=maxSamples, min_samples_leaf=minSamplesLeaf, random_state=randomState)
model4=KNeighborsClassifier(n_neighbors=2)
model5=HistGradientBoostingClassifier(max_iter=100, learning_rate=1.0, max_depth=1, randomState=100)

...

model1.fit(train, self.data['direction'][lags:5000+lags])
model2.fit(train, self.data['direction'][lags:5000+lags])
model3.fit(train, self.data['direction'][lags:5000+lags])
model4.fit(train, self.data['direction'][lags:5000+lags])
model5.fit(train, self.data['direction'][lags:5000+lags])

action1=model1.predict(train[bar-start_test, :].reshape(1, -1))
action2=model2.predict(train[bar-start_test, :].reshape(1, -1))
action3=model3.predict(train[bar-start_test, :].reshape(1, -1))
action4=model4.predict(train[bar-start_test, :].reshape(1, -1))
action5=model5.predict(train[bar-start_test, :].reshape(1, -1))
action=0
if action1==1 or action2==1 or action3==1 or action4==1 or action5==1:
	action=1
					
</code></pre>
	<p>Different models are good at predicting +1 labels in different scenarios. What is important here, is predicting the maximum number of correct +1 labels - a high recall for the +1 label prediction. To attain that we combine the +1 label predictions from all the 5 models. $$Predict=\bigcup_{i=1}^5 Predict(M_i==+1)$$ where \(M_i\) is the ith model.</p> 	
  	<p>Training this strategy over 5000 minutes of financial data and testing it over the next 3000 minutes of financial data gives the results,</p>
<pre><code class="language-python">
Running Grand Ensemble strategy | lags=10
fixed transaction costs: 0.0 | proportional transaction costs: 0.0
=======================================================
__________________________________________________
7999 | --- CLOSING OUT ---
Final net balance [$] 10089.146
Gross Performance [%] 0.891
Trades Executed   [#] 266.000
					
</code></pre>
</br>
	<h3>Putting everything together...</h3>
	<p>A connection to the <a href="https://www.metatrader5.com/en/trading-platform">MetaTrader5</a> server was established.</p>
<pre><code class="language-python">
import MetaTrader5 as mt5
import time
import datetime

# display data on the MetaTrader 5 package
print("MetaTrader5 package author: ",mt5.__author__)
print("MetaTrader5 package version: ",mt5.__version__)
        
# establish connection to the MetaTrader 5 terminal
if not mt5.initialize():
	print("initialize() failed, error code =",mt5.last_error())
	quit()
        
print("Connection to MT5 server established...")
        
# attempt to enable the display of the EURUSD in MarketWatch
selected=mt5.symbol_select("EURUSD",True)
if not selected:
	print("Failed to select EURUSD")
	mt5.shutdown()
	quit()
    
</code></pre>
	<p>The data is streamed from MetaTrader5 server and was appended to a locally created <a href="https://pandas.pydata.org/">pandas Dataframe</a>.</p>
<pre><code class="language-python">
data=pd.DataFrame()

#get and display the last EURUSD tick at interval of 30 seconds
while True:
	lasttick=mt5.symbol_info_tick("EURUSD")
	lasttick=lasttick._asdict()
	data=data.append(lasttick, ignore_index=True)	
	val=lasttick['bid']
	t=datetime.datetime.now()
	self.times.append(t)
	
	#run trading model
	
	#retrieve next tick value after 30 seconds
	time.sleep(30)

mt5.shutdown()
    
</code></pre>
	<p>The performance was monitored on <a href="https://plotly.com/">Plotly</a> graphs, in this <a href="https://github.com/AdittyaPal/21cs460_group13/blob/a9569e09218250b05dad1c765d4e04109893fa6b/formal%20code/stream.ipynb">Jupyter Notebook</a>.</p>
  </div>

<h2 id="Relevant Papers">Relevant Papers</h2>
<hr/>
<nav>
  <ul>
  	<li><a href="https://jmlr.csail.mit.edu/papers/v12/pedregosa11a.html">Scikit-learn: Machine Learning in Python</a>, <i>Pedregosa et al.</i>, JMLR 12, pp. 2825-2830, 2011.</li>
  	<li><a href="https://arxiv.org/abs/1309.0238">API design for machine learning software: experiences from the scikit-learn project</a>, <i>Buitinck et al.</i>, 2013.</li>    
	<li><a href="http://cs229.stanford.edu/proj2012/ShenJiangZhang-StockMarketForecastingusingMachineLearningAlgorithms.pdf">Stock Market Forecasting using Machine Learning Algorithms.</a> <i> S. Shen., H. Jiang, T. Zhang</i></li>	
  </ul>
</nav>
</body>
</html>
